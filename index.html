<!DOCTYPE html>
<html>
<head>
  <title>Internet Speed Test</title>
</head>
<body>
  <h1>Internet Speed Test</h1>
  <button onclick="testDownloadSpeed()">Test Download Speed</button>
  <button onclick="testUploadSpeed()">Test Upload Speed</button>
  <button onclick="testPingRate()">Test Ping Rate</button>
  <button onclick="testJitter()">Test Jitter</button>
  <button onclick="testAll()">Test All</button>
  <div id="results"></div>

  <script>
    let resultsDiv = document.querySelector("#results");

    async function testDownloadSpeed() {
    let startTime = new Date().getTime();
    let xhr = new XMLHttpRequest();

    return new Promise((resolve, reject) => {
      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4 && xhr.status == 200) {
          let endTime = new Date().getTime();
          let duration = (endTime - startTime) / 1000;
          let fileSize = 100 * 1024 * 1024; // 100 MB in bytes
          let speed = fileSize / duration;
          let downloadSpeedMbps = (speed / (1024 * 1024)).toFixed(2);
          resolve(downloadSpeedMbps);
        }
      };
      xhr.open("GET", "./100MB.bin", true);
      xhr.send();
    });
  }

  async function testUploadSpeed() {
    let startTime = new Date().getTime();
    let fileSize = 100 * 1024 * 1024; // 100 MB in bytes
    let blob = new Blob([new ArrayBuffer(fileSize)], {type: 'application/octet-stream'});
    let xhr = new XMLHttpRequest();

    return new Promise((resolve, reject) => {
      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4 && xhr.status == 200) {
          let endTime = new Date().getTime();
          let duration = (endTime - startTime) / 1000;
          let speed = fileSize / duration;
          let uploadSpeedMbps = (speed / (1024 * 1024)).toFixed(2);
          resolve(uploadSpeedMbps);
        }
      };
      xhr.open("POST", window.location.href, true);
      xhr.setRequestHeader("Content-Type", "application/octet-stream");
      xhr.send(blob);
    });
  }


  async function testPingRate() {
    let startTime = new Date().getTime();
    let xhr = new XMLHttpRequest();
    let hostname = window.location.hostname;

    return new Promise((resolve, reject) => {
      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4 && xhr.status == 200) {
          let endTime = new Date().getTime();
          let duration = (endTime - startTime) / 1000;
          let pingRate = duration.toFixed(2);
          resolve(pingRate);
        }
      };
      xhr.open("GET", "http://" + hostname + ":5000/ping", true);
      xhr.send();
    });
  }

  async function testJitter() {
    let startTime = new Date().getTime();
    let xhr = new XMLHttpRequest();
    let hostname = window.location.hostname;
    xhr.withCredentials = true;

    return new Promise((resolve, reject) => {
      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4 && xhr.status == 200) {
          let endTime = new Date().getTime();
          let duration = (endTime - startTime) / 1000;
          let jitter = JSON.parse(xhr.responseText).jitter.toFixed(2);
          resolve(jitter);
        }
      };
      xhr.open("GET", "http://" + hostname + ":5000/jitter", true);
      xhr.send();
    });
  }

    async function testAll() {
      resultsDiv.innerHTML = "Testing all...<br>";

      let downloadSpeed = await testDownloadSpeed();
      let uploadSpeed = await testUploadSpeed();
      let pingRate = await testPingRate();
      let jitter = await testJitter();

      resultsDiv.innerHTML = "Summary of all tests:<br>";
      resultsDiv.innerHTML += "Your download speed is: " + downloadSpeed + " Mbps<br>";
      resultsDiv.innerHTML += "Your upload speed is: " + uploadSpeed + " Mbps<br>";
      resultsDiv.innerHTML += "Your ping rate to " + window.location.hostname + " is: " + pingRate + " seconds<br>";
      resultsDiv.innerHTML += "Your jitter is: " + jitter + " ms";
    }
  </script>
</body>
</html>