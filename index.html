<!DOCTYPE html>
<html>
<head>
  <title>Internet Speed Test</title>
  <style>
    .progress-bar {
      background-color: #f3f3f3;
      border: 1px solid #bbb;
      height: 20px;
      width: 100%;
    }

    .progress {
      background-color: #4caf50;
      height: 100%;
      width: 0%;
    }
  </style>
</head>
<body>
  <h1>Internet Speed Test</h1>
  <button onclick="testDownloadSpeed()">Test Download Speed</button>
  <div class="progress-bar"><div id="download-progress" class="progress"></div></div>
  <button onclick="testUploadSpeed()">Test Upload Speed</button>
  <div class="progress-bar"><div id="upload-progress" class="progress"></div></div>
  <button onclick="testPingRate()">Test Ping Rate</button>
  <div class="progress-bar"><div id="ping-progress" class="progress"></div></div>
  <button onclick="testJitter()">Test Jitter</button>
  <div class="progress-bar"><div id="jitter-progress" class="progress"></div></div>
  <button onclick="testAll()">Test All</button>
  <div id="results"></div>

  <script>
    let resultsDiv = document.querySelector("#results");

    function updateProgressBar(progressBarId, percentage) {
      let progressBar = document.querySelector("#" + progressBarId);
      progressBar.style.width = percentage + "%";
    }

    function resetProgressBars() {
      updateProgressBar("download-progress", 0);
      updateProgressBar("upload-progress", 0);
      updateProgressBar("ping-progress", 0);
      updateProgressBar("jitter-progress", 0);
    }

    async function testDownloadSpeed() {
      let startTime = new Date().getTime();
      let xhr = new XMLHttpRequest();

      return new Promise((resolve, reject) => {
        xhr.onreadystatechange = function() {
          if (xhr.readyState == 4 && xhr.status == 200) {
            let endTime = new Date().getTime();
            let duration = (endTime - startTime) / 1000;
            let fileSize = 100 * 1024 * 1024; // 100 MB in bytes
            let speed = fileSize / duration;
            let downloadSpeedMbps = (speed / (1024 * 1024)).toFixed(2);
            resolve(downloadSpeedMbps);
          }
        };
        xhr.onprogress = function(event) {
          if (event.lengthComputable) {
            let percentage = (event.loaded / event.total) * 100;
            updateProgressBar("download-progress", percentage);
          }
        };
        xhr.open("GET", "./100MB.bin", true);
        xhr.send();
      });
    }

  async function testUploadSpeed() {
    let startTime = new Date().getTime();
    let fileSize = 99 * 1024 * 1024; // 100 MB in bytes
    let blob = new Blob([new ArrayBuffer(fileSize)], {type: 'application/octet-stream'});
    let xhr = new XMLHttpRequest();

    return new Promise((resolve, reject) => {
      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4 && xhr.status == 200) {
          let endTime = new Date().getTime();
          let duration = (endTime - startTime) / 1000;
          let speed = fileSize / duration;
          let uploadSpeedMbps = (speed / (1024 * 1024)).toFixed(2);
          resolve(uploadSpeedMbps);
        }
      };
      xhr.onprogress = function(event) {
          if (event.lengthComputable) {
            let percentage = (event.loaded / event.total) * 100;
            updateProgressBar("upload-progress", percentage);
          }
        };
      xhr.open("POST", window.location.href, true);
      xhr.setRequestHeader("Content-Type", "application/octet-stream");
      xhr.send(blob);
    });
  }

  async function testPingRate() {
    let startTime = new Date().getTime();
    let xhr = new XMLHttpRequest();

    return new Promise((resolve, reject) => {
      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4 && xhr.status == 200) {
          let endTime = new Date().getTime();
          let duration = (endTime - startTime) / 1000;
          let pingRate = duration.toFixed(2);
          resolve(pingRate);
        }
      };
      xhr.open("GET", window.location.href + "/ping", true);
      xhr.send();
    });
  }

  async function testJitter() {
    let startTime = new Date().getTime();
    let xhr = new XMLHttpRequest();
    xhr.withCredentials = true;

    return new Promise((resolve, reject) => {
      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4 && xhr.status == 200) {
          let endTime = new Date().getTime();
          let duration = (endTime - startTime) / 1000;
          let jitter = JSON.parse(xhr.responseText).jitter.toFixed(2);
          resolve(jitter);
        }
      };
      xhr.open("GET", window.location.href + "/jitter", true);
      xhr.send();
    });
  }

    async function testAll() {
      resetProgressBars();
      resultsDiv.innerHTML = "Testing all...<br>";

      let downloadSpeed = await testDownloadSpeed();
      let uploadSpeed = await testUploadSpeed();
      let pingRate = await testPingRate();
      updateProgressBar("ping-progress", 100);
      let jitter = await testJitter();
      updateProgressBar("jitter-progress", 100);

      resultsDiv.innerHTML = "Summary of all tests:<br>";
      resultsDiv.innerHTML += "Your download speed is: " + downloadSpeed + " Mbps<br>";
      resultsDiv.innerHTML += "Your upload speed is: " + uploadSpeed + " Mbps<br>";
      resultsDiv.innerHTML += "Your ping rate to " + window.location.hostname + " is: " + pingRate + " seconds<br>";
      resultsDiv.innerHTML += "Your jitter is: " + jitter + " ms";
    }

    document.querySelector("button[onclick='testDownloadSpeed()']").addEventListener("click", async function() {
      resultsDiv.innerHTML = "Running Download Speed Test..."
      let downloadSpeed = await testDownloadSpeed();
      resultsDiv.innerHTML = "Your download speed is: " + downloadSpeed + " Mbps";
      updateProgressBar("download-progress", 100);
    });

    document.querySelector("button[onclick='testUploadSpeed()']").addEventListener("click", async function() {
      resultsDiv.innerHTML = "Running Upload Speed Test..."
      let uploadSpeed = await testUploadSpeed();
      resultsDiv.innerHTML = "Your upload speed is: " + uploadSpeed + " Mbps";
      updateProgressBar("upload-progress", 100);
    });

    document.querySelector("button[onclick='testPingRate()']").addEventListener("click", async function() {
      resultsDiv.innerHTML = "Running Ping Test..."
      let pingRate = await testPingRate();
      resultsDiv.innerHTML = "Your ping rate to " + window.location.hostname + " is: " + pingRate + " seconds";
      updateProgressBar("ping-progress", 100);
    });

    document.querySelector("button[onclick='testJitter()']").addEventListener("click", async function() {
      resultsDiv.innerHTML = "Running Jitter Test..."
      let jitter = await testJitter();
      resultsDiv.innerHTML = "Your jitter is: " + jitter + " ms";
      updateProgressBar("jitter-progress", 100);
    });

    document.querySelector("button[onclick='testAll()']").addEventListener("click", testAll);

  </script>
</body>
</html>